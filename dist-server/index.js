"use strict";var k=Object.defineProperty;var I=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var K=(t,e,n)=>e in t?k(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,L=(t,e)=>{for(var n in e||(e={}))V.call(e,n)&&K(t,n,e[n]);if(I)for(var n of I(e))F.call(e,n)&&K(t,n,e[n]);return t};var j=(t,e,n)=>(K(t,typeof e!="symbol"?e+"":e,n),n);var M=require("awilix"),Q=require("serialport"),$=require("express"),U=require("cors"),J=require("express-queue"),X=require("path");function q(t){return t&&typeof t=="object"&&"default"in t?t:{default:t}}function Y(t){if(t&&t.__esModule)return t;var e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});return t&&Object.keys(t).forEach(function(n){if(n!=="default"){var o=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,o.get?o:{enumerable:!0,get:function(){return t[n]}})}}),e.default=t,Object.freeze(e)}var H=q($),W=q(U),Z=q(J),tt=Y(X);const et=(t,e)=>({_tag:t,value:e}),nt=t=>et("dc",t),x={sw1:0,sw2:0,sw3:0,sw4A:0,sw4B:0,sw5:0,sw6:0,sw6Suppl:0,sw7A:0,sw7B:0,sw8:0,sw9:0,sw9Suppl:0,mux1:0,mux2:0,mux3:0,mux4:0,mux5:0,tpv1:0,tpv2:0,tpv3:0,tpv4:0,tpv5:0,tpv6:0,tpv7:0,tpv8:0,tpv9:0,a1:1,a2:1,a3:1,a4:0,acDc:nt({voltage:1})},st=["tpv1","tpv2","tpv3","tpv4","tpv5","tpv6","tpv7","tpv8","tpv9"],w=t=>st.includes(t);var b={},g={};Object.defineProperty(g,"__esModule",{value:!0});g.AnonymousSelectKey=g.Select=g.Not=g.Guard=g.PatternKind=void 0;g.PatternKind=Symbol("@ts-pattern/pattern-kind");g.Guard=Symbol("@ts-pattern/guard");g.Not=Symbol("@ts-pattern/not");g.Select=Symbol("@ts-pattern/select");g.AnonymousSelectKey="@ts-pattern/__anonymous-select-key";var G={};(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.instanceOf=t.select=t.not=t.when=void 0;const e=g,n=c=>({[e.PatternKind]:e.Guard,[e.Guard]:c});t.when=n;const o=c=>({[e.PatternKind]:e.Not,[e.Not]:c});t.not=o;function m(c){return c===void 0?{[e.PatternKind]:e.Select,[e.Select]:e.AnonymousSelectKey}:{[e.PatternKind]:e.Select,[e.Select]:c}}t.select=m;function i(c){return u=>u instanceof c}const l=c=>(0,t.when)(i(c));t.instanceOf=l})(G);var N={};Object.defineProperty(N,"__esModule",{value:!0});N.__=void 0;const O=G;function ot(t){return!0}function at(t){return typeof t=="number"}function rt(t){return Number.isNaN(t)}function it(t){return typeof t=="string"}function ct(t){return typeof t=="boolean"}function ut(t){return t==null}const lt=(0,O.when)(ot),dt=(0,O.when)(it),mt=(0,O.when)(at),ft=(0,O.when)(rt),ht=(0,O.when)(ct),wt=(0,O.when)(ut);N.__=Object.assign(lt,{string:dt,number:mt,NaN:ft,boolean:ht,nullish:wt});(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.isMatching=t.match=t.instanceOf=t.select=t.not=t.when=t.__=void 0;const e=g,n=G;Object.defineProperty(t,"when",{enumerable:!0,get:function(){return n.when}}),Object.defineProperty(t,"not",{enumerable:!0,get:function(){return n.not}}),Object.defineProperty(t,"select",{enumerable:!0,get:function(){return n.select}}),Object.defineProperty(t,"instanceOf",{enumerable:!0,get:function(){return n.instanceOf}});const o=N;Object.defineProperty(t,"__",{enumerable:!0,get:function(){return o.__}});const m=s=>i(s,[]);t.match=m;const i=(s,a)=>{const f=()=>{const r=a.find(({test:h})=>h(s));if(!r){let h;try{h=JSON.stringify(s)}catch{h=s}throw new Error(`Pattern matching error: no pattern matches value ${h}`)}return r.handler(r.select(s),s)};return{with(...r){const h=r[r.length-1],y=[],v=[];for(let _=0;_<r.length-1;_++){const P=r[_];typeof P=="function"?v.push(P):y.push(P)}let A={};const D=_=>Boolean(y.some(P=>d(P,_,(R,z)=>{A[R]=z}))&&v.every(P=>P(_)));return i(s,a.concat([{test:D,handler:h,select:_=>Object.keys(A).length?e.AnonymousSelectKey in A?A[e.AnonymousSelectKey]:A:_}]))},when:(r,h)=>i(s,a.concat([{test:r,handler:h,select:y=>y}])),otherwise:r=>i(s,a.concat([{test:()=>!0,handler:r,select:h=>h}])).run(),exhaustive:()=>f(),run:f}},l=s=>Boolean(s&&typeof s=="object"),c=s=>{const a=s;return a&&a[e.PatternKind]===e.Guard},u=s=>{const a=s;return a&&a[e.PatternKind]===e.Not},p=s=>{const a=s;return a&&a[e.PatternKind]===e.Select},d=(s,a,f)=>{if(l(s)){if(c(s))return Boolean(s[e.Guard](a));if(p(s))return f(s[e.Select],a),!0;if(u(s))return!d(s[e.Not],a,f);if(!l(a))return!1;if(Array.isArray(s)){if(!Array.isArray(a))return!1;if(s.length===1){const r={},h=(v,A)=>{r[v]=(r[v]||[]).concat([A])},y=a.every(v=>d(s[0],v,h));return y&&Object.keys(r).forEach(v=>f(v,r[v])),y}return s.length===a.length?s.every((r,h)=>d(r,a[h],f)):!1}if(s instanceof Map)return a instanceof Map?[...s.keys()].every(r=>d(s.get(r),a.get(r),f)):!1;if(s instanceof Set){if(!(a instanceof Set))return!1;if(s.size===0)return a.size===0;if(s.size===1){const[r]=[...s.values()];return Object.values(o.__).includes(r)?d([r],[...a.values()],f):a.has(r)}return[...s.values()].every(r=>a.has(r))}return Object.keys(s).every(r=>r in a&&d(s[r],a[r],f))}return a===s};function S(...s){if(s.length===1){const[a]=s;return f=>d(a,f,()=>{})}if(s.length===2){const[a,f]=s;return d(a,f,()=>{})}throw new Error(`isMatching wasn't given enough arguments: expected 1 or 2, received ${s.length}.`)}t.isMatching=S})(b);const pt=[0,1,4,12,2,6,14],gt=[0,8,2,1,3,5,7],vt=[0,8,2,1,3,5,7],yt=(t,e)=>b.match(t).with(0,()=>b.match(e).with(0,()=>0).otherwise(()=>2)).otherwise(()=>b.match(e).with(0,()=>1).otherwise(()=>3)),_t=[0,1,6,10,2,12,4,8],bt=[0,1,2,4,6,12,14],St=(t,e)=>b.match(t).with(0,()=>b.match(e).with(0,()=>0).with(1,()=>2).otherwise(()=>4)).with(1,()=>b.match(e).with(0,()=>1).with(1,()=>3).otherwise(()=>5)).otherwise(()=>b.match(e).with(0,()=>8).with(1,()=>10).otherwise(()=>12)),At=[0,1,2,4,8],Pt=[0,1,4,2,6,14],Mt=[0,1,2,3,4,5,6,7,8],Ot=[0,1,2,3,4,5,6,7,8],Ct=[0,1,2,3,4,5,6,7,8],jt=[0,1,2,3,4,5,6,7,8],Nt=[0,1,2,3,4,5,6,7,8],Kt=t=>{const e=[];e[3]=yt(t.sw4A,t.sw4B),e[6]=St(t.sw7A,t.sw7B);const n={1:["sw1",pt],2:["sw2",gt],3:["sw3",vt],5:["sw5",_t],6:["sw6",bt],8:["sw8",At],9:["sw9",Pt]};for(const u in n){const[p,d]=n[u];e[parseInt(u)-1]=d[t[p]]}const o=[],m={1:["mux1",Mt],2:["mux2",Ot],3:["mux3",Ct],4:["mux4",jt],5:["mux5",Nt]};for(const u in m){const[p,d]=m[u];o[parseInt(u)-1]=d[t[p]]}const i=e.map((u,p)=>`at+sw=${p+1}, ${u.toString(16)}`),l=o.map((u,p)=>`at+mux=${p+1}, ${u.toString(16)}`),c=`at+rl=${parseInt([t.a3,t.a2,t.a1].join(""),2)}`;return[...i,...l,c]},$t=({atService:t,state:e})=>async n=>{const o=Kt(n);for await(const i of o)await t.sendAtCommand(i);const{acDc:m}=n;m._tag==="ac"?(await t.sendAtCommand(`at+ddsf=${m.value.frequency}`),await t.sendAtCommand(`at+ddsa=${Math.floor(6016*m.value.voltage)}`),await t.sendAtCommand("at+dds=1")):(await t.sendAtCommand("at+dds=0"),await t.sendAtCommand(`at+dac=${Math.floor(m.value.voltage*3008)}`)),await t.sendAtCommand("at+swa?"),await t.sendAtCommand("at+muxa?"),e.circuit=n},T=t=>t.reduce((e,n)=>e+n)/t.length,B=t=>[...t].map(Math.abs).sort((e,n)=>n-e).slice(0,5).reduce((e,n)=>e+n)/5,qt=({atService:t,state:e})=>async(n,o)=>{const m={tpv1:"v1",tpv2:"v2",tpv3:"v3",tpv4:"v4",tpv5:"v5",tpv6:"v6",tpv7:"v7",tpv8:"v8",tpv9:"v9",a1:"a1",a2:"a2",a3:"a3",a4:"a4"},i=await t.getAdcData(m[n],m[o]),l=c=>w(c)?1:c==="a4"?3.99392/1.06:4.67289/1.072/(e.circuit[c]===0?4:1);return e.circuit.acDc._tag==="dc"?{channel1:{values:w(n)?i.channel1:i.channel1.map(c=>c*l(n)),average:T(i.channel1)*l(n),min:w(n)?-5:n==="a4"?-43:-45,max:w(n)?5:n==="a4"?43:45,unit:w(n)?"\u0412":"\u043C\u0410"},channel2:{values:w(o)?i.channel2:i.channel2.map(c=>c*l(o)),average:T(i.channel2)*l(o),min:w(o)?-5:o==="a4"?-43:-45,max:w(o)?5:o==="a4"?43:45,unit:w(o)?"\u0412":"\u043C\u0410"}}:{channel1:{values:w(n)?i.channel1:i.channel1.map(c=>c*l(n)),average:B(i.channel1)*Math.SQRT1_2*l(n),min:0,max:w(n)?10:n==="a4"?31:35,unit:w(n)?"\u0412":"\u043C\u0410"},channel2:{values:w(o)?i.channel2:i.channel2.map(c=>c*l(o)),average:B(i.channel2)*Math.SQRT1_2*l(o),min:0,max:w(o)?10:o==="a4"?31:35,unit:w(o)?"\u0412":"\u043C\u0410"}}};class Gt{constructor({port:e}){j(this,"_port");j(this,"_lastPromise",Promise.resolve());j(this,"_lastPromiseResult","");this._port=e}sendAtCommand(e){const n=`${e}\r
`;return this._lastPromise.finally(()=>{const o=new Promise((m,i)=>{const l=u=>{const p=setTimeout(()=>i(),5e3);console.log("Result in sendAtCommand",u.toString()),this._lastPromiseResult+=u.toString(),this._lastPromiseResult.includes("OK")&&(m(u),this._port.removeListener("data",l),clearTimeout(p))},c=u=>{this._port.on("data",l),u&&(console.log("Error",u.toString()),i(u))};this._port.write(n,c)});return this._lastPromise=o,o})}async getAdcData(e,n){return await this.sendAtCommand("at+adcs=1024"),await this.sendAtCommand("at+adcd=4"),await this.sendAtCommand(`at+adc=1, ${e}`),await this.sendAtCommand(`at+adc=2, ${n}`),new Promise((o,m)=>{let i=Buffer.from([]);const l=u=>{i=Buffer.concat([i,u])},c=u=>{this._port.on("data",l),u&&(console.log("Error",u.toString()),m(u))};this._port.write(`at+adc\r
`,c),setTimeout(()=>{const u=[],p=[];let d=[],S=[];for(const s of i.slice(12).entries()){const[a,f]=s;a%4===0||a%4===1?d.push(f):S.push(f)}d=Buffer.from(d),S=Buffer.from(S);for(let s=0;s<d.length;s++)s%2||u.push(d.readInt16LE(s));for(let s=0;s<S.length;s++)s%2||p.push(S.readInt16LE(s));return this._port.removeListener("data",l),o({channel1:E(u),channel2:E(p)})},500)})}}const E=t=>t.map(e=>(e-2048)*10/1751),C=M.createContainer({injectionMode:M.InjectionMode.PROXY}).register({port:M.asValue(new Q.SerialPort({path:"/dev/ttyUSB0",baudRate:921600,autoOpen:!1})),state:M.asValue({circuit:L({},x)}),setState:M.asFunction($t),getChannels:M.asFunction(qt),atService:M.asClass(Gt)}),It=H.default().use($.static(tt.resolve(__dirname,"../dist-client"))).use($.json()).use((t,e,n)=>{console.log(t.ip),n()}).use(W.default({origin:"*"})).get("/",(t,e)=>{console.log("hello"),e.send("hello")}).use(Z.default({activeLimit:1,queuedLimit:-1})).post("/state",async(t,e,n)=>{try{console.log("state");const o=await C.cradle.setState(t.body);e.json(o)}catch(o){n(o)}}).get("/channels",async(t,e,n)=>{try{console.log("channels");const o=await C.cradle.getChannels(t.query.channel1,t.query.channel2);e.json(o)}catch(o){n(o)}}).use((t,e,n,o)=>{n.status(500),n.json({message:t.message,stack:!1})});C.cradle.port.open(t=>{t?console.log(t):C.cradle.atService.sendAtCommand("ate1").then(()=>C.cradle.setState(x)).then(e=>{It.listen(3030,"0.0.0.0",()=>{console.log("App listening on http://localhost:3030")})})});
