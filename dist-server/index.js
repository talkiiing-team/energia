"use strict";var Y=Object.defineProperty;var T=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var q=(t,e,n)=>e in t?Y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,G=(t,e)=>{for(var n in e||(e={}))Z.call(e,n)&&q(t,n,e[n]);if(T)for(var n of T(e))k.call(e,n)&&q(t,n,e[n]);return t};var C=(t,e,n)=>(q(t,typeof e!="symbol"?e+"":e,n),n);var F=require("path"),A=require("awilix"),tt=require("serialport"),B=require("express"),et=require("cors"),nt=require("express-queue");function $(t){return t&&typeof t=="object"&&"default"in t?t:{default:t}}function rt(t){if(t&&t.__esModule)return t;var e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});return t&&Object.keys(t).forEach(function(n){if(n!=="default"){var s=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,s.get?s:{enumerable:!0,get:function(){return t[n]}})}}),e.default=t,Object.freeze(e)}var V=$(F),st=rt(F),ot=$(B),at=$(et),ct=$(nt);function it(t){if(t.__esModule)return t;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(t).forEach(function(n){var s=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,s.get?s:{enumerable:!0,get:function(){return t[n]}})}),e}var I={exports:{}},ut={},lt=Object.freeze(Object.defineProperty({__proto__:null,default:ut},Symbol.toStringTag,{value:"Module"})),Q=it(lt);const dt=Q,U=V.default,mt=Q,ft=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function ht(t){const e={};let n=t.toString();n=n.replace(/\r\n?/mg,`
`);let s;for(;(s=ft.exec(n))!=null;){const d=s[1];let o=s[2]||"";o=o.trim();const i=o[0];o=o.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),i==='"'&&(o=o.replace(/\\n/g,`
`),o=o.replace(/\\r/g,"\r")),e[d]=o}return e}function x(t){console.log(`[dotenv][DEBUG] ${t}`)}function pt(t){return t[0]==="~"?U.join(mt.homedir(),t.slice(1)):t}function wt(t){let e=U.resolve(process.cwd(),".env"),n="utf8";const s=Boolean(t&&t.debug),d=Boolean(t&&t.override);t&&(t.path!=null&&(e=pt(t.path)),t.encoding!=null&&(n=t.encoding));try{const o=N.parse(dt.readFileSync(e,{encoding:n}));return Object.keys(o).forEach(function(i){Object.prototype.hasOwnProperty.call(process.env,i)?(d===!0&&(process.env[i]=o[i]),s&&x(d===!0?`"${i}" is already defined in \`process.env\` and WAS overwritten`:`"${i}" is already defined in \`process.env\` and was NOT overwritten`)):process.env[i]=o[i]}),{parsed:o}}catch(o){return s&&x(`Failed to load ${e} ${o.message}`),{error:o}}}const N={config:wt,parse:ht};var gt=I.exports.config=N.config;I.exports.parse=N.parse;I.exports=N;const vt=(t,e)=>({_tag:t,value:e}),yt=t=>vt("dc",t),W={sw1:0,sw2:0,sw3:0,sw4A:0,sw4B:0,sw5:0,sw6:0,sw6Suppl:0,sw7A:0,sw7B:0,sw8:0,sw9:0,sw9Suppl:0,mux1:0,mux2:0,mux3:0,mux4:0,mux5:0,tpv1:0,tpv2:0,tpv3:0,tpv4:0,tpv5:0,tpv6:0,tpv7:0,tpv8:0,tpv9:0,a1:1,a2:1,a3:1,a4:0,acDc:yt({voltage:1})},_t=["tpv1","tpv2","tpv3","tpv4","tpv5","tpv6","tpv7","tpv8","tpv9"],p=t=>_t.includes(t);var b={},g={};Object.defineProperty(g,"__esModule",{value:!0});g.AnonymousSelectKey=g.Select=g.Not=g.Guard=g.PatternKind=void 0;g.PatternKind=Symbol("@ts-pattern/pattern-kind");g.Guard=Symbol("@ts-pattern/guard");g.Not=Symbol("@ts-pattern/not");g.Select=Symbol("@ts-pattern/select");g.AnonymousSelectKey="@ts-pattern/__anonymous-select-key";var K={};(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.instanceOf=t.select=t.not=t.when=void 0;const e=g,n=u=>({[e.PatternKind]:e.Guard,[e.Guard]:u});t.when=n;const s=u=>({[e.PatternKind]:e.Not,[e.Not]:u});t.not=s;function d(u){return u===void 0?{[e.PatternKind]:e.Select,[e.Select]:e.AnonymousSelectKey}:{[e.PatternKind]:e.Select,[e.Select]:u}}t.select=d;function o(u){return l=>l instanceof u}const i=u=>(0,t.when)(o(u));t.instanceOf=i})(K);var E={};Object.defineProperty(E,"__esModule",{value:!0});E.__=void 0;const j=K;function bt(t){return!0}function St(t){return typeof t=="number"}function Ot(t){return Number.isNaN(t)}function Pt(t){return typeof t=="string"}function At(t){return typeof t=="boolean"}function jt(t){return t==null}const Mt=(0,j.when)(bt),Ct=(0,j.when)(Pt),$t=(0,j.when)(St),Nt=(0,j.when)(Ot),Et=(0,j.when)(At),qt=(0,j.when)(jt);E.__=Object.assign(Mt,{string:Ct,number:$t,NaN:Nt,boolean:Et,nullish:qt});(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.isMatching=t.match=t.instanceOf=t.select=t.not=t.when=t.__=void 0;const e=g,n=K;Object.defineProperty(t,"when",{enumerable:!0,get:function(){return n.when}}),Object.defineProperty(t,"not",{enumerable:!0,get:function(){return n.not}}),Object.defineProperty(t,"select",{enumerable:!0,get:function(){return n.select}}),Object.defineProperty(t,"instanceOf",{enumerable:!0,get:function(){return n.instanceOf}});const s=E;Object.defineProperty(t,"__",{enumerable:!0,get:function(){return s.__}});const d=r=>o(r,[]);t.match=d;const o=(r,a)=>{const f=()=>{const c=a.find(({test:h})=>h(r));if(!c){let h;try{h=JSON.stringify(r)}catch{h=r}throw new Error(`Pattern matching error: no pattern matches value ${h}`)}return c.handler(c.select(r),r)};return{with(...c){const h=c[c.length-1],y=[],v=[];for(let _=0;_<c.length-1;_++){const P=c[_];typeof P=="function"?v.push(P):y.push(P)}let O={};const H=_=>Boolean(y.some(P=>m(P,_,(J,X)=>{O[J]=X}))&&v.every(P=>P(_)));return o(r,a.concat([{test:H,handler:h,select:_=>Object.keys(O).length?e.AnonymousSelectKey in O?O[e.AnonymousSelectKey]:O:_}]))},when:(c,h)=>o(r,a.concat([{test:c,handler:h,select:y=>y}])),otherwise:c=>o(r,a.concat([{test:()=>!0,handler:c,select:h=>h}])).run(),exhaustive:()=>f(),run:f}},i=r=>Boolean(r&&typeof r=="object"),u=r=>{const a=r;return a&&a[e.PatternKind]===e.Guard},l=r=>{const a=r;return a&&a[e.PatternKind]===e.Not},w=r=>{const a=r;return a&&a[e.PatternKind]===e.Select},m=(r,a,f)=>{if(i(r)){if(u(r))return Boolean(r[e.Guard](a));if(w(r))return f(r[e.Select],a),!0;if(l(r))return!m(r[e.Not],a,f);if(!i(a))return!1;if(Array.isArray(r)){if(!Array.isArray(a))return!1;if(r.length===1){const c={},h=(v,O)=>{c[v]=(c[v]||[]).concat([O])},y=a.every(v=>m(r[0],v,h));return y&&Object.keys(c).forEach(v=>f(v,c[v])),y}return r.length===a.length?r.every((c,h)=>m(c,a[h],f)):!1}if(r instanceof Map)return a instanceof Map?[...r.keys()].every(c=>m(r.get(c),a.get(c),f)):!1;if(r instanceof Set){if(!(a instanceof Set))return!1;if(r.size===0)return a.size===0;if(r.size===1){const[c]=[...r.values()];return Object.values(s.__).includes(c)?m([c],[...a.values()],f):a.has(c)}return[...r.values()].every(c=>a.has(c))}return Object.keys(r).every(c=>c in a&&m(r[c],a[c],f))}return a===r};function S(...r){if(r.length===1){const[a]=r;return f=>m(a,f,()=>{})}if(r.length===2){const[a,f]=r;return m(a,f,()=>{})}throw new Error(`isMatching wasn't given enough arguments: expected 1 or 2, received ${r.length}.`)}t.isMatching=S})(b);const xt=[0,1,4,12,2,6,14],Bt=[0,8,2,1,3,5,7],It=[0,8,2,1,3,5,7],Kt=(t,e)=>b.match(t).with(0,()=>b.match(e).with(0,()=>0).otherwise(()=>2)).otherwise(()=>b.match(e).with(0,()=>1).otherwise(()=>3)),Tt=[0,1,6,10,2,12,4,8],Gt=[0,1,2,4,6,12,14],Lt=(t,e)=>b.match(t).with(0,()=>b.match(e).with(0,()=>0).with(1,()=>2).otherwise(()=>4)).with(1,()=>b.match(e).with(0,()=>1).with(1,()=>3).otherwise(()=>5)).otherwise(()=>b.match(e).with(0,()=>8).with(1,()=>10).otherwise(()=>12)),Dt=[0,1,2,4,8],Rt=[0,1,4,2,6,14],zt=[0,1,2,3,4,5,6,7,8],Ft=[0,1,2,3,4,5,6,7,8],Vt=[0,1,2,3,4,5,6,7,8],Qt=[0,1,2,3,4,5,6,7,8],Ut=[0,1,2,3,4,5,6,7,8],Wt=t=>{const e=[];e[3]=Kt(t.sw4A,t.sw4B),e[6]=Lt(t.sw7A,t.sw7B);const n={1:["sw1",xt],2:["sw2",Bt],3:["sw3",It],5:["sw5",Tt],6:["sw6",Gt],8:["sw8",Dt],9:["sw9",Rt]};for(const l in n){const[w,m]=n[l];e[parseInt(l)-1]=m[t[w]]}const s=[],d={1:["mux1",zt],2:["mux2",Ft],3:["mux3",Vt],4:["mux4",Qt],5:["mux5",Ut]};for(const l in d){const[w,m]=d[l];s[parseInt(l)-1]=m[t[w]]}const o=e.map((l,w)=>`at+sw=${w+1}, ${l.toString(16)}`),i=s.map((l,w)=>`at+mux=${w+1}, ${l.toString(16)}`),u=`at+rl=${parseInt([t.a3,t.a2,t.a1].join(""),2)}`;return[...o,...i,u]},Ht=({atService:t,state:e})=>async n=>{const s=Wt(n);for await(const o of s)await t.sendAtCommand(o);const{acDc:d}=n;d._tag==="ac"?(await t.sendAtCommand(`at+ddsf=${d.value.frequency}`),await t.sendAtCommand(`at+ddsa=${Math.floor(6016*d.value.voltage)}`),await t.sendAtCommand("at+dds=1")):(await t.sendAtCommand("at+dds=0"),await t.sendAtCommand(`at+dac=${Math.floor(d.value.voltage*3008)}`)),await t.sendAtCommand("at+swa?"),await t.sendAtCommand("at+muxa?"),e.circuit=n},L=t=>t.reduce((e,n)=>e+n)/t.length,D=t=>[...t].map(Math.abs).sort((e,n)=>n-e).slice(0,5).reduce((e,n)=>e+n)/5,Jt=({atService:t,state:e})=>async(n,s)=>{const d={tpv1:"v1",tpv2:"v2",tpv3:"v3",tpv4:"v4",tpv5:"v5",tpv6:"v6",tpv7:"v7",tpv8:"v8",tpv9:"v9",a1:"a1",a2:"a2",a3:"a3",a4:"a4"},o=await t.getAdcData(d[n],d[s]),i=u=>p(u)?1:u==="a4"?3.99392/1.06:4.67289/1.072/(e.circuit[u]===0?4:1);return e.circuit.acDc._tag==="dc"?{channel1:{values:p(n)?o.channel1:o.channel1.map(u=>u*i(n)),average:L(o.channel1)*i(n),min:p(n)?-5:n==="a4"?-43:-45,max:p(n)?5:n==="a4"?43:45,unit:p(n)?"\u0412":"\u043C\u0410"},channel2:{values:p(s)?o.channel2:o.channel2.map(u=>u*i(s)),average:L(o.channel2)*i(s),min:p(s)?-5:s==="a4"?-43:-45,max:p(s)?5:s==="a4"?43:45,unit:p(s)?"\u0412":"\u043C\u0410"}}:{channel1:{values:p(n)?o.channel1:o.channel1.map(u=>u*i(n)),average:D(o.channel1)*Math.SQRT1_2*i(n),min:0,max:p(n)?10:n==="a4"?31:35,unit:p(n)?"\u0412":"\u043C\u0410"},channel2:{values:p(s)?o.channel2:o.channel2.map(u=>u*i(s)),average:D(o.channel2)*Math.SQRT1_2*i(s),min:0,max:p(s)?10:s==="a4"?31:35,unit:p(s)?"\u0412":"\u043C\u0410"}}};class Xt{constructor({port:e}){C(this,"_port");C(this,"_lastPromise",Promise.resolve());C(this,"_lastPromiseResult","");this._port=e}sendAtCommand(e){const n=`${e}\r
`;return this._lastPromise.finally(()=>{const s=new Promise((d,o)=>{const i=l=>{const w=setTimeout(()=>o(),5e3);console.log("Result in sendAtCommand",l.toString()),this._lastPromiseResult+=l.toString(),this._lastPromiseResult.includes("OK")&&(d(l),this._port.removeListener("data",i),clearTimeout(w))},u=l=>{this._port.on("data",i),l&&(console.log("Error",l.toString()),o(l))};this._port.write(n,u)});return this._lastPromise=s,s})}async getAdcData(e,n){return await this.sendAtCommand("at+adcs=1024"),await this.sendAtCommand("at+adcd=4"),await this.sendAtCommand(`at+adc=1, ${e}`),await this.sendAtCommand(`at+adc=2, ${n}`),new Promise((s,d)=>{let o=Buffer.from([]);const i=l=>{o=Buffer.concat([o,l])},u=l=>{this._port.on("data",i),l&&(console.log("Error",l.toString()),d(l))};this._port.write(`at+adc\r
`,u),setTimeout(()=>{const l=[],w=[];let m=[],S=[];for(const r of o.slice(12).entries()){const[a,f]=r;a%4===0||a%4===1?m.push(f):S.push(f)}m=Buffer.from(m),S=Buffer.from(S);for(let r=0;r<m.length;r++)r%2||l.push(m.readInt16LE(r));for(let r=0;r<S.length;r++)r%2||w.push(S.readInt16LE(r));return this._port.removeListener("data",i),s({channel1:R(l),channel2:R(w)})},500)})}}const R=t=>t.map(e=>(e-2048)*10/1751),{SERIAL_PORT:Yt="/dev/ttyUSB0"}=process.env,M=A.createContainer({injectionMode:A.InjectionMode.PROXY}).register({port:A.asValue(new tt.SerialPort({path:Yt,baudRate:921600,autoOpen:!1})),state:A.asValue({circuit:G({},W)}),setState:A.asFunction(Ht),getChannels:A.asFunction(Jt),atService:A.asClass(Xt)}),{PASSWORD:Zt="VerySecure"}=process.env,kt=ot.default().use(B.static(st.resolve(__dirname,"../dist-client"))).use(B.json()).use(at.default({origin:"*"})).get("/",(t,e)=>{console.log("hello"),e.send("hello")}).use((t,e,n)=>{if(t.headers.authorization!==Zt)return e.status(401),n(new Error("Not authorized"));n()}).use(ct.default({activeLimit:1,queuedLimit:-1})).post("/state",async(t,e,n)=>{try{console.log("state");const s=await M.cradle.setState(t.body);e.json(s)}catch(s){n(s)}}).get("/channels",async(t,e,n)=>{try{console.log("channels");const s=await M.cradle.getChannels(t.query.channel1,t.query.channel2);e.json(s)}catch(s){n(s)}}).get("/auth",async(t,e,n)=>{e.json(!0)}).use((t,e,n,s)=>{n.status(n.statusCode||500),n.json({message:t.message,stack:!1})}),te=gt({path:V.default.resolve(__dirname,"../.env")});console.log(te);const{PORT:z="3030"}=process.env;M.cradle.port.open(t=>{t?console.log(t):M.cradle.atService.sendAtCommand("ate1").then(()=>M.cradle.setState(W)).then(e=>{kt.listen(parseInt(z),"0.0.0.0",()=>{console.log("App listening on http://localhost:"+z)})})});
