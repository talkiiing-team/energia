"use strict";var k=Object.defineProperty;var I=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var q=(t,e,n)=>e in t?k(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,G=(t,e)=>{for(var n in e||(e={}))Q.call(e,n)&&q(t,n,e[n]);if(I)for(var n of I(e))U.call(e,n)&&q(t,n,e[n]);return t};var j=(t,e,n)=>(q(t,typeof e!="symbol"?e+"":e,n),n);var J=require("dotenv"),D=require("path"),b=require("awilix"),W=require("serialport"),B=require("express"),X=require("cors"),Y=require("express-queue");function E(t){return t&&typeof t=="object"&&"default"in t?t:{default:t}}function H(t){if(t&&t.__esModule)return t;var e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});return t&&Object.keys(t).forEach(function(n){if(n!=="default"){var o=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,o.get?o:{enumerable:!0,get:function(){return t[n]}})}}),e.default=t,Object.freeze(e)}var Z=E(D),tt=H(D),et=E(B),nt=E(X),st=E(Y);const ot=(t,e)=>({_tag:t,value:e}),rt=t=>ot("dc",t),x={sw1:0,sw2:0,sw3:0,sw4A:0,sw4B:0,sw5:0,sw6:0,sw6Suppl:0,sw7A:0,sw7B:0,sw8:0,sw9:0,sw9Suppl:0,mux1:0,mux2:0,mux3:0,mux4:0,mux5:0,tpv1:0,tpv2:0,tpv3:0,tpv4:0,tpv5:0,tpv6:0,tpv7:0,tpv8:0,tpv9:0,a1:1,a2:1,a3:1,a4:0,acDc:rt({voltage:1})},at=["tpv1","tpv2","tpv3","tpv4","tpv5","tpv6","tpv7","tpv8","tpv9"],w=t=>at.includes(t);var P={},g={};Object.defineProperty(g,"__esModule",{value:!0});g.AnonymousSelectKey=g.Select=g.Not=g.Guard=g.PatternKind=void 0;g.PatternKind=Symbol("@ts-pattern/pattern-kind");g.Guard=Symbol("@ts-pattern/guard");g.Not=Symbol("@ts-pattern/not");g.Select=Symbol("@ts-pattern/select");g.AnonymousSelectKey="@ts-pattern/__anonymous-select-key";var $={};(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.instanceOf=t.select=t.not=t.when=void 0;const e=g,n=i=>({[e.PatternKind]:e.Guard,[e.Guard]:i});t.when=n;const o=i=>({[e.PatternKind]:e.Not,[e.Not]:i});t.not=o;function m(i){return i===void 0?{[e.PatternKind]:e.Select,[e.Select]:e.AnonymousSelectKey}:{[e.PatternKind]:e.Select,[e.Select]:i}}t.select=m;function u(i){return c=>c instanceof i}const l=i=>(0,t.when)(u(i));t.instanceOf=l})($);var N={};Object.defineProperty(N,"__esModule",{value:!0});N.__=void 0;const M=$;function ut(t){return!0}function it(t){return typeof t=="number"}function ct(t){return Number.isNaN(t)}function lt(t){return typeof t=="string"}function dt(t){return typeof t=="boolean"}function mt(t){return t==null}const ft=(0,M.when)(ut),ht=(0,M.when)(lt),wt=(0,M.when)(it),pt=(0,M.when)(ct),gt=(0,M.when)(dt),vt=(0,M.when)(mt);N.__=Object.assign(ft,{string:ht,number:wt,NaN:pt,boolean:gt,nullish:vt});(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.isMatching=t.match=t.instanceOf=t.select=t.not=t.when=t.__=void 0;const e=g,n=$;Object.defineProperty(t,"when",{enumerable:!0,get:function(){return n.when}}),Object.defineProperty(t,"not",{enumerable:!0,get:function(){return n.not}}),Object.defineProperty(t,"select",{enumerable:!0,get:function(){return n.select}}),Object.defineProperty(t,"instanceOf",{enumerable:!0,get:function(){return n.instanceOf}});const o=N;Object.defineProperty(t,"__",{enumerable:!0,get:function(){return o.__}});const m=s=>u(s,[]);t.match=m;const u=(s,r)=>{const f=()=>{const a=r.find(({test:h})=>h(s));if(!a){let h;try{h=JSON.stringify(s)}catch{h=s}throw new Error(`Pattern matching error: no pattern matches value ${h}`)}return a.handler(a.select(s),s)};return{with(...a){const h=a[a.length-1],y=[],v=[];for(let _=0;_<a.length-1;_++){const O=a[_];typeof O=="function"?v.push(O):y.push(O)}let A={};const F=_=>Boolean(y.some(O=>d(O,_,(z,V)=>{A[z]=V}))&&v.every(O=>O(_)));return u(s,r.concat([{test:F,handler:h,select:_=>Object.keys(A).length?e.AnonymousSelectKey in A?A[e.AnonymousSelectKey]:A:_}]))},when:(a,h)=>u(s,r.concat([{test:a,handler:h,select:y=>y}])),otherwise:a=>u(s,r.concat([{test:()=>!0,handler:a,select:h=>h}])).run(),exhaustive:()=>f(),run:f}},l=s=>Boolean(s&&typeof s=="object"),i=s=>{const r=s;return r&&r[e.PatternKind]===e.Guard},c=s=>{const r=s;return r&&r[e.PatternKind]===e.Not},p=s=>{const r=s;return r&&r[e.PatternKind]===e.Select},d=(s,r,f)=>{if(l(s)){if(i(s))return Boolean(s[e.Guard](r));if(p(s))return f(s[e.Select],r),!0;if(c(s))return!d(s[e.Not],r,f);if(!l(r))return!1;if(Array.isArray(s)){if(!Array.isArray(r))return!1;if(s.length===1){const a={},h=(v,A)=>{a[v]=(a[v]||[]).concat([A])},y=r.every(v=>d(s[0],v,h));return y&&Object.keys(a).forEach(v=>f(v,a[v])),y}return s.length===r.length?s.every((a,h)=>d(a,r[h],f)):!1}if(s instanceof Map)return r instanceof Map?[...s.keys()].every(a=>d(s.get(a),r.get(a),f)):!1;if(s instanceof Set){if(!(r instanceof Set))return!1;if(s.size===0)return r.size===0;if(s.size===1){const[a]=[...s.values()];return Object.values(o.__).includes(a)?d([a],[...r.values()],f):r.has(a)}return[...s.values()].every(a=>r.has(a))}return Object.keys(s).every(a=>a in r&&d(s[a],r[a],f))}return r===s};function S(...s){if(s.length===1){const[r]=s;return f=>d(r,f,()=>{})}if(s.length===2){const[r,f]=s;return d(r,f,()=>{})}throw new Error(`isMatching wasn't given enough arguments: expected 1 or 2, received ${s.length}.`)}t.isMatching=S})(P);const yt=[0,1,4,12,2,6,14],_t=[0,8,2,1,3,5,7],bt=[0,8,2,1,3,5,7],Pt=(t,e)=>P.match(t).with(0,()=>P.match(e).with(0,()=>0).otherwise(()=>2)).otherwise(()=>P.match(e).with(0,()=>1).otherwise(()=>3)),St=[0,1,6,10,2,12,4,8],At=[0,1,2,4,6,12,14],Ot=(t,e)=>P.match(t).with(0,()=>P.match(e).with(0,()=>0).with(1,()=>2).otherwise(()=>4)).with(1,()=>P.match(e).with(0,()=>1).with(1,()=>3).otherwise(()=>5)).otherwise(()=>P.match(e).with(0,()=>8).with(1,()=>10).otherwise(()=>12)),Ct=[0,1,2,4,8],Mt=[0,1,4,2,6,14],jt=[0,1,2,3,4,5,6,7,8],Et=[0,1,2,3,4,5,6,7,8],Nt=[0,1,2,3,4,5,6,7,8],qt=[0,1,2,3,4,5,6,7,8],Bt=[0,1,2,3,4,5,6,7,8],Kt=t=>{const e=[];e[3]=Pt(t.sw4A,t.sw4B),e[6]=Ot(t.sw7A,t.sw7B);const n={1:["sw1",yt],2:["sw2",_t],3:["sw3",bt],5:["sw5",St],6:["sw6",At],8:["sw8",Ct],9:["sw9",Mt]};for(const c in n){const[p,d]=n[c];e[parseInt(c)-1]=d[t[p]]}const o=[],m={1:["mux1",jt],2:["mux2",Et],3:["mux3",Nt],4:["mux4",qt],5:["mux5",Bt]};for(const c in m){const[p,d]=m[c];o[parseInt(c)-1]=d[t[p]]}const u=e.map((c,p)=>`at+sw=${p+1}, ${c.toString(16)}`),l=o.map((c,p)=>`at+mux=${p+1}, ${c.toString(16)}`),i=`at+rl=${parseInt([t.a3,t.a2,t.a1].join(""),2)}`;return[...u,...l,i]},$t=({atService:t,state:e})=>async n=>{const o=Kt(n);for await(const u of o)await t.sendAtCommand(u);const{acDc:m}=n;m._tag==="ac"?(await t.sendAtCommand(`at+ddsf=${m.value.frequency}`),await t.sendAtCommand(`at+ddsa=${Math.floor(6016*m.value.voltage)}`),await t.sendAtCommand("at+dds=1")):(await t.sendAtCommand("at+dds=0"),await t.sendAtCommand(`at+dac=${Math.floor(m.value.voltage*3008)}`)),await t.sendAtCommand("at+swa?"),await t.sendAtCommand("at+muxa?"),e.circuit=n},L=t=>t.reduce((e,n)=>e+n)/t.length,T=t=>[...t].map(Math.abs).sort((e,n)=>n-e).slice(0,5).reduce((e,n)=>e+n)/5,It=({atService:t,state:e})=>async(n,o)=>{const m={tpv1:"v1",tpv2:"v2",tpv3:"v3",tpv4:"v4",tpv5:"v5",tpv6:"v6",tpv7:"v7",tpv8:"v8",tpv9:"v9",a1:"a1",a2:"a2",a3:"a3",a4:"a4"},u=await t.getAdcData(m[n],m[o]),l=i=>w(i)?1:i==="a4"?3.99392/1.06:4.67289/1.072/(e.circuit[i]===0?4:1);return e.circuit.acDc._tag==="dc"?{channel1:{values:w(n)?u.channel1:u.channel1.map(i=>i*l(n)),average:L(u.channel1)*l(n),min:w(n)?-5:n==="a4"?-43:-45,max:w(n)?5:n==="a4"?43:45,unit:w(n)?"\u0412":"\u043C\u0410"},channel2:{values:w(o)?u.channel2:u.channel2.map(i=>i*l(o)),average:L(u.channel2)*l(o),min:w(o)?-5:o==="a4"?-43:-45,max:w(o)?5:o==="a4"?43:45,unit:w(o)?"\u0412":"\u043C\u0410"}}:{channel1:{values:w(n)?u.channel1:u.channel1.map(i=>i*l(n)),average:T(u.channel1)*Math.SQRT1_2*l(n),min:0,max:w(n)?10:n==="a4"?31:35,unit:w(n)?"\u0412":"\u043C\u0410"},channel2:{values:w(o)?u.channel2:u.channel2.map(i=>i*l(o)),average:T(u.channel2)*Math.SQRT1_2*l(o),min:0,max:w(o)?10:o==="a4"?31:35,unit:w(o)?"\u0412":"\u043C\u0410"}}};class K extends Error{}class Gt{constructor({port:e}){j(this,"_port");j(this,"_lastPromise",Promise.resolve());j(this,"_lastPromiseResult","");this._port=e}sendAtCommand(e){const n=`${e}\r
`;return this._lastPromise.finally(()=>{const o=new Promise((m,u)=>{if(console.log(this._port.isOpen),!this._port.isOpen)return u(new K);const l=c=>{const p=setTimeout(()=>u(),5e3);console.log("Result in sendAtCommand",c.toString()),this._lastPromiseResult+=c.toString(),this._lastPromiseResult.includes("OK")&&(m(c),this._port.removeListener("data",l),clearTimeout(p))},i=c=>{this._port.on("data",l),c&&(console.log("Error",c.toString()),u(c))};this._port.write(n,i)});return this._lastPromise=o,o})}async getAdcData(e,n){if(console.log(this._port.isOpen),!this._port.isOpen)throw new K;return await this.sendAtCommand("at+adcs=1024"),await this.sendAtCommand("at+adcd=4"),await this.sendAtCommand(`at+adc=1, ${e}`),await this.sendAtCommand(`at+adc=2, ${n}`),new Promise((o,m)=>{let u=Buffer.from([]);const l=c=>{u=Buffer.concat([u,c])},i=c=>{this._port.on("data",l),c&&(console.log("Error",c.toString()),m(c))};this._port.write(`at+adc\r
`,i),setTimeout(()=>{const c=[],p=[];let d=[],S=[];for(const s of u.slice(12).entries()){const[r,f]=s;r%4===0||r%4===1?d.push(f):S.push(f)}d=Buffer.from(d),S=Buffer.from(S);for(let s=0;s<d.length;s++)s%2||c.push(d.readInt16LE(s));for(let s=0;s<S.length;s++)s%2||p.push(S.readInt16LE(s));return this._port.removeListener("data",l),o({channel1:R(c),channel2:R(p)})},500)})}}const R=t=>t.map(e=>(e-2048)*10/1751);J.config({path:Z.default.resolve(__dirname,"../.env")});const{SERIAL_PORT:Lt="/dev/ttyUSB0",PORT:Tt="3030"}=process.env,C=b.createContainer({injectionMode:b.InjectionMode.PROXY}).register({port:b.asValue(new W.SerialPort({path:Lt,baudRate:921600,autoOpen:!1})),state:b.asValue({circuit:G({},x)}),setState:b.asFunction($t),getChannels:b.asFunction(It),atService:b.asClass(Gt),serverPort:b.asValue(parseInt(Tt))}),{PASSWORD:Rt="VerySecure"}=process.env,Dt=et.default().use(B.static(tt.resolve(__dirname,"../dist-client"))).use(B.json()).use(nt.default({origin:"*"})).get("/",(t,e)=>{console.log("hello"),e.send("hello")}).use((t,e,n)=>{if(t.headers.authorization!==Rt)return e.status(401),n(new Error("\u041D\u0435\u0442 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438"));n()}).use(st.default({activeLimit:1,queuedLimit:-1})).post("/state",async(t,e,n)=>{try{console.log("state");const o=await C.cradle.setState(t.body);e.json(o)}catch(o){n(o)}}).get("/channels",async(t,e,n)=>{try{console.log("channels");const o=await C.cradle.getChannels(t.query.channel1,t.query.channel2);e.json(o)}catch(o){n(o)}}).get("/auth",async(t,e,n)=>{e.json(!0)}).use((t,e,n,o)=>{if(t instanceof K)return n.status(503).json({message:"\u041F\u0440\u043E\u0431\u043B\u0435\u043C\u044B \u0441 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435\u043C \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0430. \u041F\u043E\u0434\u043A\u043B\u044E\u0447\u0438\u0442\u0435 \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u043E \u0438 \u043F\u0435\u0440\u0435\u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u0435 \u0441\u0435\u0440\u0432\u0435\u0440."});n.status(n.statusCode||500),n.json({message:t.message,stack:!1})});C.cradle.port.open(t=>{t?console.log(t):C.cradle.atService.sendAtCommand("ate1").then(()=>C.cradle.setState(x)).then(()=>{Dt.listen(C.cradle.serverPort,"0.0.0.0",()=>{console.log("Backend listening on http://localhost:"+C.cradle.serverPort)})})});
